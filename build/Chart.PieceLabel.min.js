/**
 * [Chart.PieceLabel.js]{@link https://github.com/emn178/Chart.PieceLabel.js}
 *
 * @version 0.13.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2017-2018
 * @license MIT
 */
(function(){function p(){this.drawDataset=this.drawDataset.bind(this)}function v(a){a.options.pieceLabel&&!a.pieceLabel&&(a.pieceLabel=new p);return a.pieceLabel}"undefined"===typeof Chart?console.warn("Can not find Chart object."):(p.prototype.beforeDatasetsUpdate=function(a){if(this.parseOptions(a)&&"outside"===this.position){var b=1.5*this.fontSize+this.outsidePadding;a.chartArea.top+=b;a.chartArea.bottom-=b}},p.prototype.afterDatasetsDraw=function(a){this.parseOptions(a)&&(this.labelBounds=[],
a.config.data.datasets.forEach(this.drawDataset))},p.prototype.drawDataset=function(a){for(var b=this.ctx,d=this.chartInstance,h=a._meta[Object.keys(a._meta)[0]],k=0,g=0;g<h.data.length;g++){var e=h.data[g],c=e._view;if(0!==c.circumference||this.showZero){switch(this.render){case "value":var f=a.data[g];this.format&&(f=this.format(f));f=f.toString();break;case "label":f=d.config.data.labels[g];break;case "image":f=this.images[g]?this.loadImage(this.images[g]):"";break;default:var n=c.circumference/
this.options.circumference*100;n=parseFloat(n.toFixed(this.precision));this.showActualPercentages||(k+=n,100<k&&(n-=k-100,n=parseFloat(n.toFixed(this.precision))));f=n+"%"}"function"===typeof this.render&&(f=this.render({label:d.config.data.labels[g],value:a.data[g],percentage:n,dataset:a,index:g}),"object"===typeof f&&(f=this.loadImage(f)));if(f){b.save();b.beginPath();b.font=Chart.helpers.fontString(this.fontSize,this.fontStyle,this.fontFamily);if("outside"===this.position||"border"===this.position){var l=
c.outerRadius/2;var m=this.fontSize+this.textMargin;var q=c.startAngle+(c.endAngle-c.startAngle)/2;if("border"===this.position)var p=(c.outerRadius-l)/2+l;else"outside"===this.position&&(this.arc||(m=this.textMargin),p=c.outerRadius-l+l+m);q={x:c.x+Math.cos(q)*p,y:c.y+Math.sin(q)*p};if("outside"===this.position){this.arc||(m+=this.measureText(f).width/2);q.x=q.x<c.x?q.x-m:q.x+m;var t=c.outerRadius+m}}else l=c.innerRadius,q=e.tooltipPosition();m=this.fontColor;"function"===typeof m?m=m({label:d.config.data.labels[g],
value:a.data[g],percentage:n,text:f,backgroundColor:a.backgroundColor[g],dataset:a,index:g}):"string"!==typeof m&&(m=m[g]||this.options.defaultFontColor);if(this.arc)t||(t=(l+c.outerRadius)/2),b.fillStyle=m,b.textBaseline="middle",this.drawArcText(f,t,c,this.overlap);else{var r=this.measureText(f);c=q.x-r.width/2;l=q.x+r.width/2;var u=q.y-r.height/2;r=q.y+r.height/2;(this.overlap||("outside"===this.position?this.checkTextBound(c,l,u,r):e.inRange(c,u)&&e.inRange(c,r)&&e.inRange(l,u)&&e.inRange(l,r)))&&
this.fillText(f,q,m)}b.restore()}}}},p.prototype.parseOptions=function(a){var b=a.options.pieceLabel;return b?(this.chartInstance=a,this.ctx=a.chart.ctx,this.options=a.config.options,this.render=b.render||b.mode,this.position=b.position||"default",this.arc=b.arc,this.format=b.format,this.precision=b.precision||0,this.fontSize=b.fontSize||this.options.defaultFontSize,this.fontColor=b.fontColor||this.options.defaultFontColor,this.fontStyle=b.fontStyle||this.options.defaultFontStyle,this.fontFamily=
b.fontFamily||this.options.defaultFontFamily,this.shadowOffsetX=b.shadowOffsetX||3,this.shadowOffsetY=b.shadowOffsetY||3,this.shadowColor=b.shadowColor||"rgba(0,0,0,0.3)",this.shadowBlur=b.shadowBlur||6,this.textShadow=b.textShadow||!1,this.hasTooltip=a.tooltip._active&&a.tooltip._active.length,this.showZero=b.showZero,this.overlap=b.overlap,this.images=b.images||[],this.outsidePadding=b.outsidePadding||2,this.textMargin=b.textMargin||2,this.showActualPercentages=b.showActualPercentages||!1,!0):!1},
p.prototype.checkTextBound=function(a,b,d,h){for(var k=this.labelBounds,g=0;g<k.length;++g){for(var e=k[g],c=[[a,d],[a,h],[b,d],[b,h]],f=0;f<c.length;++f){var n=c[f][0],l=c[f][1];if(n>=e.left&&n<=e.right&&l>=e.top&&l<=e.bottom)return!1}c=[[e.left,e.top],[e.left,e.bottom],[e.right,e.top],[e.right,e.bottom]];for(f=0;f<c.length;++f)if(n=c[f][0],l=c[f][1],n>=a&&n<=b&&l>=d&&l<=h)return!1}k.push({left:a,right:b,top:d,bottom:h});return!0},p.prototype.measureText=function(a){if("object"===typeof a)return{width:a.width,
height:a.height};var b=0;a=a.split("\n");for(var d=0;d<a.length;++d){var h=this.ctx.measureText(a[d]);h.width>b&&(b=h.width)}return{width:b,height:this.fontSize*a.length}},p.prototype.fillText=function(a,b,d){var h=this.ctx;if("object"===typeof a)h.drawImage(a,b.x-a.width/2,b.y-a.height/2,a.width,a.height);else{h.save();h.fillStyle=d;h.textBaseline="top";h.textAlign="center";this.textShadow&&(h.shadowOffsetX=this.shadowOffsetX,h.shadowOffsetY=this.shadowOffsetY,h.shadowColor=this.shadowColor,h.shadowBlur=
this.shadowBlur);a=a.split("\n");for(d=0;d<a.length;d++)h.fillText(a[d],b.x,b.y-this.fontSize/2*a.length+this.fontSize*d);h.restore()}},p.prototype.loadImage=function(a){var b=new Image;b.src=a.src;b.width=a.width;b.height=a.height;return b},p.prototype.drawArcText=function(a,b,d,h){var k=this.ctx,g=d.x,e=d.y,c=d.startAngle;d=d.endAngle;k.save();k.translate(g,e);e=d-c;c+=Math.PI/2;d+=Math.PI/2;var f=c;g=this.measureText(a);c+=(d-(g.width/b+c))/2;if(h||!(d-c>e))if("string"===typeof a){k.rotate(c);
a=a.split("\n");h=0;c=[];d=0;"border"===this.position&&(d=(a.length-1)*this.fontSize/2);for(e=0;e<a.length;++e)g=k.measureText(a[e]),g.width>h&&(h=g.width),c.push(g.width);for(e=0;e<a.length;++e){f=a[e];var n=(a.length-1-e)*-this.fontSize+d;k.save();k.rotate((h-c[e])/2/b);for(var l=0;l<f.length;l++){var m=f.charAt(l);g=k.measureText(m);k.save();k.translate(0,-1*b);k.fillText(m,0,n);k.restore();k.rotate(g.width/b)}k.restore()}}else k.rotate((f+d)/2),k.translate(0,-1*b),this.fillText(a,{x:0,y:0});k.restore()},
Chart.pluginService.register({beforeDatasetsUpdate:function(a){v(a)&&a.pieceLabel.beforeDatasetsUpdate(a)},afterDatasetsDraw:function(a){v(a)&&a.pieceLabel.afterDatasetsDraw(a)}}))})();
